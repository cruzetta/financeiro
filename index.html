<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Comando Financeiro</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons via CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos personalizados e base */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        .tab-active {
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            font-weight: 600;
        }
        /* Anima√ß√£o para o Toast */
        .toast-enter {
            opacity: 0;
            transform: translateY(20px);
        }
        .toast-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 300ms, transform 300ms;
        }
        .toast-exit {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-exit-active {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 300ms, transform 300ms;
        }
        /* Para garantir que os √≠cones Lucide sejam renderizados corretamente */
        [data-lucide] {
            width: 1em;
            height: 1em;
        }
        .btn-loading .btn-text {
            visibility: hidden;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: button-loading-spinner 1s ease infinite;
        }
        @keyframes button-loading-spinner {
            from {
                transform: rotate(0turn);
            }
            to {
                transform: rotate(1turn);
            }
        }
    </style>
</head>
<body class="text-gray-800">
    <!-- Tela de Autentica√ß√£o -->
    <div id="auth-container" class="hidden flex items-center justify-center min-h-screen bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <div>
                <h2 class="text-2xl font-bold text-center text-gray-800">Centro de Comando Financeiro</h2>
                <p class="mt-2 text-sm text-center text-gray-600">Acesse ou crie sua conta para continuar</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div class="space-y-2">
                    <label for="email" class="text-sm font-medium">Email</label>
                    <input type="email" id="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="space-y-2">
                    <label for="password" class="text-sm font-medium">Senha</label>
                    <input type="password" id="password" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="auth-error" class="text-sm text-red-600 min-h-[1.25rem]"></div>
                <div class="flex flex-col space-y-2">
                    <button type="submit" name="action" value="login" class="relative w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="btn-text">Entrar</span>
                    </button>
                    <button type="submit" name="action" value="signup" class="relative w-full px-4 py-2 font-semibold text-white bg-gray-600 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="btn-text">Cadastrar Nova Conta</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tela de Carregamento -->
    <div id="loading-container" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="text-center p-4">
            <i data-lucide="loader-2" class="w-16 h-16 mx-auto text-blue-500 animate-spin"></i>
            <p class="mt-4 text-lg text-gray-600">Carregando...</p>
        </div>
    </div>
    
    <!-- Container Principal da Aplica√ß√£o -->
    <div id="app-container" class="hidden max-w-7xl mx-auto p-4 md:p-6">
        
        <!-- Cabe√ßalho -->
        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Centro de Comando Financeiro</h1>
                <p id="user-display" class="text-gray-500 text-xs md:text-sm break-all"></p>
            </div>
            <button id="logout-btn" class="bg-red-500 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-red-600 flex items-center gap-2">
                <i data-lucide="log-out" class="w-5 h-5"></i> Sair
            </button>
        </header>

        <!-- Faixa de Erro de Conex√£o -->
        <div id="firestore-error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert"></div>

        <!-- Navega√ß√£o por Abas -->
        <nav class="mb-6 border-b border-gray-200">
            <ul class="flex space-x-4 md:space-x-8 -mb-px">
                <li><button data-tab="dashboard" class="tab-item py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Dashboard</button></li>
                <li><button data-tab="consultoria" class="tab-item py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Consultoria</button></li>
                <li><button data-tab="relatorios" class="tab-item py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Hist√≥rico & Relat√≥rios</button></li>
            </ul>
        </nav>

        <!-- Conte√∫do das Abas -->
        <main id="tab-content">
            <!-- ABA: Dashboard Principal -->
            <div id="dashboard-content" class="space-y-8">
                <!-- Seletor de Per√≠odo -->
                <div class="flex items-center justify-center space-x-4 bg-white p-4 rounded-lg shadow-sm">
                    <button id="prev-period" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                    <h2 id="period-display" class="text-xl font-semibold text-center w-80"></h2>
                    <button id="next-period" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                </div>

                <!-- Cards de Resumo (KPIs) -->
                <div id="kpi-cards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <!-- Cards ser√£o injetados aqui -->
                </div>
                
                <!-- Bot√£o de Nova Transa√ß√£o Avulsa -->
                <div class="flex justify-end">
                    <button id="add-generic-transaction-btn" class="bg-blue-500 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-blue-600 flex items-center gap-2">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i> Nova Transa√ß√£o
                    </button>
                </div>

                <!-- Atalhos de Lan√ßamentos -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Atalhos de Receitas -->
                    <div class="bg-white p-6 rounded-lg shadow-sm space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-2xl font-bold text-green-600">Receitas</h3>
                            <button data-type="receita" class="new-shortcut-btn bg-green-500 text-white font-semibold px-3 py-1 rounded-lg hover:bg-green-600 flex items-center gap-2 text-sm">
                                <i data-lucide="plus" class="w-4 h-4"></i> Novo Atalho
                            </button>
                        </div>
                        <div id="receitas-shortcuts" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                            <!-- Cards de atalho de receita -->
                        </div>
                    </div>
                    <!-- Atalhos de Despesas -->
                    <div class="bg-white p-6 rounded-lg shadow-sm space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-2xl font-bold text-red-600">Despesas</h3>
                            <button data-type="despesa" class="new-shortcut-btn bg-red-500 text-white font-semibold px-3 py-1 rounded-lg hover:bg-red-600 flex items-center gap-2 text-sm">
                                <i data-lucide="plus" class="w-4 h-4"></i> Novo Atalho
                            </button>
                        </div>
                        <div id="despesas-shortcuts" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                            <!-- Cards de atalho de despesa -->
                        </div>
                    </div>
                </div>

                <!-- Lista de Transa√ß√µes do Per√≠odo -->
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-2xl font-bold mb-4">Transa√ß√µes do Per√≠odo</h3>
                    <input type="text" id="transaction-search" placeholder="üîé Filtrar por descri√ß√£o..." class="w-full mb-4 p-2 border border-gray-300 rounded-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b">
                                    <th class="p-2">Status</th>
                                    <th class="p-2">Descri√ß√£o</th>
                                    <th class="p-2 text-right">Valor</th>
                                    <th class="p-2">Data</th>
                                    <th class="p-2 text-center">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-list">
                                <!-- Linhas de transa√ß√£o ser√£o injetadas aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ABA: M√≥dulo de Consultoria -->
            <div id="consultoria-content" class="hidden">
                 <!-- Esta √°rea ir√° alternar entre a lista de clientes e os detalhes de um cliente -->
            </div>

            <!-- ABA: Hist√≥rico & Relat√≥rios -->
            <div id="relatorios-content" class="hidden text-center p-10 bg-white rounded-lg shadow-sm">
                <i data-lucide="hard-hat" class="w-16 h-16 mx-auto text-yellow-500 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-700">Em Desenvolvimento</h2>
                <p class="text-gray-500 mt-2">Esta se√ß√£o est√° em constru√ß√£o. Volte em breve para novas funcionalidades!</p>
            </div>
        </main>
    </div>

    <!-- Modal Gen√©rico -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-md m-auto transform transition-all">
            <!-- Conte√∫do do modal ser√° injetado aqui -->
        </div>
    </div>

    <!-- Toast de Notifica√ß√£o -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <!-- TEMPLATES HTML (para clonagem) -->
    <template id="kpi-card-template">
        <div class="p-4 rounded-lg shadow-sm text-center">
            <h4 class="text-sm font-medium text-gray-500"></h4>
            <p class="text-2xl font-bold"></p>
        </div>
    </template>
    
    <template id="transaction-row-template">
        <tr class="border-b last:border-b-0 hover:bg-gray-50">
            <td class="p-2">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" class="status-checkbox form-checkbox h-5 w-5 rounded text-blue-500 border-gray-300 focus:ring-blue-500">
                    <span class="status-text text-sm"></span>
                </label>
            </td>
            <td class="p-2 flex items-center gap-2">
                <i class="type-icon w-5 h-5"></i>
                <span class="description-text font-medium"></span>
            </td>
            <td class="p-2 text-right value-text"></td>
            <td class="p-2 text-sm text-gray-600 date-text"></td>
            <td class="p-2">
                <div class="flex justify-center items-center gap-2">
                    <button class="edit-btn p-1 text-gray-500 hover:text-blue-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                    <button class="delete-btn p-1 text-gray-500 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            </td>
        </tr>
    </template>
    
    <template id="shortcut-card-template">
        <div class="shortcut-card relative group flex flex-col items-center justify-center p-3 border rounded-lg cursor-pointer hover:shadow-md hover:border-blue-400 transition-shadow h-full">
            <i class="shortcut-icon w-8 h-8 mb-1"></i>
            <span class="shortcut-name text-sm text-center font-medium"></span>
            <span class="shortcut-total text-sm font-bold mt-1"></span>
            <div class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                 <button class="edit-shortcut-btn p-1 text-gray-400 hover:text-blue-500" title="Editar Atalho"><i data-lucide="edit-3" class="w-3 h-3"></i></button>
                 <button class="delete-shortcut-btn p-1 text-gray-400 hover:text-red-500" title="Excluir Permanentemente"><i data-lucide="shield-x" class="w-3 h-3"></i></button>
            </div>
        </div>
    </template>
    
    <template id="client-list-view-template">
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-bold">Clientes</h2>
                <button id="add-client-btn" class="bg-blue-500 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-blue-600 flex items-center gap-2">
                    <i data-lucide="user-plus" class="w-5 h-5"></i> Novo Cliente
                </button>
            </div>
            <div id="client-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Cards de cliente ser√£o inseridos aqui -->
            </div>
        </div>
    </template>

    <template id="client-card-template">
        <div class="client-card bg-white p-6 rounded-lg shadow-sm hover:shadow-lg transition-shadow cursor-pointer">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="client-name text-xl font-bold"></h3>
                    <p class="client-value text-gray-500 text-sm"></p>
                </div>
                <button class="edit-client-btn p-1 text-gray-400 hover:text-blue-500"><i data-lucide="edit" class="w-4 h-4"></i></button>
            </div>
        </div>
    </template>
    
    <template id="client-detail-view-template">
        <div class="space-y-8">
            <button id="back-to-clients-btn" class="flex items-center gap-2 text-sm text-gray-600 hover:text-blue-500 font-semibold mb-4">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Voltar para Clientes
            </button>
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 id="detail-client-name" class="text-3xl font-bold"></h2>
                        <p id="detail-client-value" class="text-gray-500"></p>
                    </div>
                     <button id="add-abate-btn" class="bg-teal-500 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-teal-600 flex items-center gap-2">
                         <i data-lucide="git-commit" class="w-5 h-5"></i> Novo Abate
                     </button>
                </div>
                
                <h3 class="text-xl font-bold mb-4">Abates no Per√≠odo</h3>
                 <div class="overflow-x-auto">
                     <table class="w-full text-left">
                         <thead>
                             <tr class="border-b">
                                 <th class="p-2">Data</th>
                                 <th class="p-2">N¬∫ Cabe√ßas</th>
                                 <th class="p-2 text-right">Receita Total</th>
                                 <th class="p-2 text-right">Custo Total</th>
                                 <th class="p-2 text-center">A√ß√µes</th>
                             </tr>
                         </thead>
                         <tbody id="abate-list">
                             <!-- Linhas de abate ser√£o inseridas aqui -->
                         </tbody>
                     </table>
                </div>
            </div>
        </div>
    </template>
    
    <template id="abate-row-template">
        <tr class="border-b last:border-b-0 hover:bg-gray-50">
            <td class="p-2 abate-date"></td>
            <td class="p-2 abate-heads"></td>
            <td class="p-2 text-right abate-revenue text-green-600 font-medium"></td>
            <td class="p-2 text-right abate-cost text-red-600 font-medium"></td>
            <td class="p-2">
                 <div class="flex justify-center items-center gap-2">
                     <button class="edit-abate-btn p-1 text-gray-500 hover:text-blue-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                     <button class="delete-abate-btn p-1 text-gray-500 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                 </div>
            </td>
        </tr>
    </template>

    <!-- Firebase SDKs (Vers√£o Atualizada) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore,
            collection,
            doc,
            addDoc,
            setDoc,
            deleteDoc,
            onSnapshot,
            query,
            writeBatch,
            enableIndexedDbPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================================
        // CONFIGURA√á√ÉO DO FIREBASE
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBxAjPzd-OoQU_CPeMawa6QtSLcwbY3J4A",
            authDomain: "financeiro-4fd9a.firebaseapp.com",
            projectId: "financeiro-4fd9a",
            storageBucket: "financeiro-4fd9a.firebasestorage.app",
            messagingSenderId: "82912149153",
            appId: "1:82912149153:web:293977f1d12145eebb3ae0",
            measurementId: "G-GL40EGD9YM"
        };
        // =================================================================================

        let fbApp, auth, db;

        // =================================================================================
        // ESTADO DA APLICA√á√ÉO E CONFIGURA√á√ïES
        // =================================================================================
        const AppState = {
            currentTab: 'dashboard',
            currentPeriodStartDate: null,
            transactions: [],
            shortcuts: [],
            clients: [],
            abates: [],
            currentClientId: null,
            userId: null, 
            listeners: [], 
        };

        const LOCAL_STORAGE_KEYS = {
            currentPeriod: `finance_app_currentPeriod_v1`,
        };
        
        // =================================================================================
        // FUN√á√ïES UTILIT√ÅRIAS
        // =================================================================================
        const generateUUID = () => crypto.randomUUID();
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
        
        const formatCurrencyInput = (input) => {
            let value = input.value.replace(/\D/g, '');
            if (value === '') { input.value = ''; return; }
            value = (parseInt(value, 10) / 100);
            if (isNaN(value)) { input.value = "0,00"; return; }
            input.value = value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        const formatDate = (date) => {
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
        };
        
        const parseCurrency = (stringValue) => {
            if (typeof stringValue !== 'string' || stringValue === '') return 0;
            const number = Number(String(stringValue).replace(/\./g, '').replace(',', '.'));
            return isNaN(number) ? 0 : number;
        };
        
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
            toast.className = `toast-enter toast-enter-active text-white px-4 py-2 rounded-lg shadow-lg ${colors[type]}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('toast-enter', 'toast-enter-active');
                toast.classList.add('toast-exit', 'toast-exit-active');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        };
        
        // =================================================================================
        // L√ìGICA DE DADOS (FIRESTORE)
        // =================================================================================
        const setupFirestoreListeners = (userId) => {
            if (AppState.listeners.length > 0) detachFirestoreListeners();
            const firestoreErrorBanner = document.getElementById('firestore-error-banner');
            firestoreErrorBanner.classList.add('hidden'); 

            const collections = ['transactions', 'shortcuts', 'clients', 'abates'];
            collections.forEach(collName => {
                const collPath = `users/${userId}/${collName}`;
                const q = query(collection(db, collPath));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    AppState[collName] = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAll(); 
                }, (error) => {
                    console.error(`Error listening to ${collName}: `, error);
                    firestoreErrorBanner.innerHTML = `<p class="font-bold">Erro de Liga√ß√£o com a Base de Dados.</p><p>Verifique sua internet e as regras de seguran√ßa do seu projeto Firebase.</p>`;
                    firestoreErrorBanner.classList.remove('hidden');
                });
                AppState.listeners.push(unsubscribe);
            });
        };

        const detachFirestoreListeners = () => {
            AppState.listeners.forEach(unsubscribe => unsubscribe());
            AppState.listeners = [];
        };

        // =================================================================================
        // L√ìGICA DE PER√çODO
        // =================================================================================
        const initializePeriod = () => {
            const savedPeriod = localStorage.getItem(LOCAL_STORAGE_KEYS.currentPeriod);
            if(savedPeriod) {
                AppState.currentPeriodStartDate = new Date(savedPeriod);
                return;
            }
            const today = new Date();
            const currentDay = today.getDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            if (currentDay <= 10) {
                AppState.currentPeriodStartDate = new Date(Date.UTC(currentYear, currentMonth - 1, 11));
            } else {
                AppState.currentPeriodStartDate = new Date(Date.UTC(currentYear, currentMonth, 11));
            }
        };
        
        const getPeriodBounds = (startDate) => {
            const start = new Date(startDate);
            const end = new Date(start);
            end.setUTCMonth(end.getUTCMonth() + 1);
            end.setUTCDate(10);
            return { start, end };
        };

        const changePeriod = (direction) => {
            const newStartDate = new Date(AppState.currentPeriodStartDate);
            newStartDate.setUTCMonth(newStartDate.getUTCMonth() + direction);
            AppState.currentPeriodStartDate = newStartDate;
            localStorage.setItem(LOCAL_STORAGE_KEYS.currentPeriod, newStartDate.toISOString());
            renderAll();
        };

        // =================================================================================
        // L√ìGICA DO MODAL
        // =================================================================================
        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');

        const openModal = (htmlContent, onOpen) => {
            modalContent.innerHTML = htmlContent;
            modalContainer.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            lucide.createIcons({ nodes: [modalContent] });
            if(onOpen) onOpen();
        };
        
        const closeModal = () => {
            modalContainer.classList.add('hidden');
            modalContent.innerHTML = '';
            document.body.style.overflow = 'auto';
        };

        modalContainer.addEventListener('click', (e) => {
            if (e.target === modalContainer) closeModal();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modalContainer.classList.contains('hidden')) closeModal();
        });
        
        const openConfirmationModal = (message, onConfirm) => {
            const html = `
                <div class="p-6">
                    <div class="flex items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Confirma√ß√£o Necess√°ria</h3>
                            <div class="mt-2"><p class="text-sm text-gray-500">${message}</p></div>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                        <button id="confirm-ok-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Confirmar</button>
                        <button id="confirm-cancel-btn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Cancelar</button>
                    </div>
                </div>`;
            openModal(html, () => {
                document.getElementById('confirm-cancel-btn').addEventListener('click', closeModal);
                document.getElementById('confirm-ok-btn').addEventListener('click', () => {
                    closeModal();
                    onConfirm();
                });
            });
        };

        // =================================================================================
        // L√ìGICA DE RENDERIZA√á√ÉO
        // =================================================================================
        const renderAll=()=>{renderTabs();if(AppState.userId){switch(AppState.currentTab){case'dashboard':renderDashboard();break;case'consultoria':renderConsultoria();break;}}
        lucide.createIcons();};const renderTabs=()=>{document.querySelectorAll('.tab-item').forEach(t=>{t.classList.toggle('tab-active',t.dataset.tab===AppState.currentTab)});document.querySelectorAll('#tab-content > div').forEach(c=>{c.classList.toggle('hidden',c.id!==`${AppState.currentTab}-content`)});};const renderDashboard=()=>{renderPeriodDisplay();renderKPIs();renderShortcuts();renderTransactionList();};const renderConsultoria=()=>{if(AppState.currentClientId){renderClientDetailView(AppState.currentClientId)}else{renderClientListView()}};const renderPeriodDisplay=()=>{if(!AppState.currentPeriodStartDate)return;const{start,end}=getPeriodBounds(AppState.currentPeriodStartDate);const options={day:'2-digit',month:'short',year:'numeric',timeZone:'UTC'};const formattedStart=start.toLocaleDateString('pt-BR',options).replace(/\./g,'').replace(' de ','/');const formattedEnd=end.toLocaleDateString('pt-BR',options).replace(/\./g,'').replace(' de ','/');document.getElementById('period-display').textContent=`${formattedStart} a ${formattedEnd}`;};const renderKPIs=()=>{if(!AppState.currentPeriodStartDate)return;const{start,end}=getPeriodBounds(AppState.currentPeriodStartDate);const transactionsInPeriod=AppState.transactions.filter(t=>{const tDate=t.date.toDate?t.date.toDate():new Date(t.date);return!t.isDeleted&&tDate>=start&&tDate<=end});const recebido=transactionsInPeriod.filter(t=>t.type==='receita'&&t.status==='recebido').reduce((s,t)=>s+t.value,0);const pago=transactionsInPeriod.filter(t=>t.type==='despesa'&&t.status==='pago').reduce((s,t)=>s+t.value,0);const aReceber=transactionsInPeriod.filter(t=>t.type==='receita'&&t.status==='a receber').reduce((s,t)=>s+t.value,0);const aPagar=transactionsInPeriod.filter(t=>t.type==='despesa'&&t.status==='a pagar').reduce((s,t)=>s+t.value,0);const saldoPrevisto=(recebido+aReceber)-(pago+aPagar);const kpis=[{title:'Recebido',value:recebido,color:'text-green-600',bg:'bg-green-50'},{title:'Pago',value:pago,color:'text-red-600',bg:'bg-red-50'},{title:'Saldo Atual',value:recebido-pago,color:'text-blue-600',bg:'bg-blue-50'},{title:'A Receber',value:aReceber,color:'text-yellow-600',bg:'bg-yellow-50'},{title:'A Pagar',value:aPagar,color:'text-orange-600',bg:'bg-orange-50'},{title:'Saldo Previsto',value:saldoPrevisto,color:saldoPrevisto<0?'text-red-600':'text-indigo-600',bg:saldoPrevisto<0?'bg-red-50':'bg-indigo-50'}];const container=document.getElementById('kpi-cards');container.innerHTML='';const template=document.getElementById('kpi-card-template');kpis.forEach(kpi=>{const card=template.content.cloneNode(true).firstElementChild;card.querySelector('h4').textContent=kpi.title;card.querySelector('p').textContent=formatCurrency(kpi.value);card.querySelector('p').className=`text-2xl font-bold ${kpi.color}`;card.className=`p-4 rounded-lg shadow-sm text-center ${kpi.bg}`;container.appendChild(card)});};const renderShortcuts=()=>{const rC=document.getElementById('receitas-shortcuts');const dC=document.getElementById('despesas-shortcuts');rC.innerHTML='';dC.innerHTML='';if(!AppState.currentPeriodStartDate)return;const{start,end}=getPeriodBounds(AppState.currentPeriodStartDate);const template=document.getElementById('shortcut-card-template');AppState.shortcuts.forEach(s=>{const card=template.content.cloneNode(true).firstElementChild;card.dataset.id=s.id;card.querySelector('.shortcut-icon').setAttribute('data-lucide',s.icon||'dollar-sign');card.querySelector('.shortcut-name').textContent=s.name;const tE=card.querySelector('.shortcut-total');const cTC=s.type==='receita'?'text-green-700':'text-red-700';if(s.frequency==='variavel'){const mT=AppState.transactions.filter(t=>{const tD=t.date.toDate?t.date.toDate():new Date(t.date);return!t.isDeleted&&t.shortcutId===s.id&&tD>=start&&tD<=end});const mTotal=mT.reduce((sum,t)=>sum+t.value,0);tE.textContent=formatCurrency(mTotal);tE.className=`text-sm font-bold mt-1 ${cTC}`}else{tE.textContent=formatCurrency(s.value);tE.className=`text-sm font-bold mt-1 ${cTC}`}
        const container=s.type==='receita'?rC:dC;container.appendChild(card)});};const renderTransactionList=()=>{const container=document.getElementById('transaction-list');container.innerHTML='';if(!AppState.currentPeriodStartDate)return;const{start,end}=getPeriodBounds(AppState.currentPeriodStartDate);const searchTerm=document.getElementById('transaction-search').value.toLowerCase();const transactionsInPeriod=AppState.transactions.filter(t=>{const tDate=t.date.toDate?t.date.toDate():new Date(t.date);const matchesSearch=t.description.toLowerCase().includes(searchTerm);return!t.isDeleted&&tDate>=start&&tDate<=end&&matchesSearch}).sort((a,b)=>{const aDate=a.date.toDate?a.date.toDate():new Date(a.date);const bDate=b.date.toDate?b.date.toDate():new Date(b.date);return bDate-aDate});if(transactionsInPeriod.length===0){container.innerHTML=`<tr><td colspan="5" class="text-center text-gray-500 py-8">Nenhuma transa√ß√£o encontrada para este per√≠odo.</td></tr>`;return}
        const template=document.getElementById('transaction-row-template');transactionsInPeriod.forEach(t=>{const row=template.content.cloneNode(true).firstElementChild;row.dataset.id=t.id;const checkbox=row.querySelector('.status-checkbox');const statusText=row.querySelector('.status-text');const typeIcon=row.querySelector('.type-icon');const descriptionText=row.querySelector('.description-text');const valueText=row.querySelector('.value-text');const dateText=row.querySelector('.date-text');checkbox.checked=(t.type==='receita'&&t.status==='recebido')||(t.type==='despesa'&&t.status==='pago');statusText.textContent=t.status==='recebido'||t.status==='pago'?'Conclu√≠do':'Pendente';statusText.className=`text-sm ${checkbox.checked?'text-green-600':'text-yellow-600'}`;typeIcon.setAttribute('data-lucide',t.type==='receita'?'trending-up':'trending-down');typeIcon.className=`type-icon w-5 h-5 ${t.type==='receita'?'text-green-600':'text-red-600'}`;descriptionText.textContent=t.description;valueText.textContent=formatCurrency(t.value);valueText.className=`p-2 text-right value-text font-medium ${t.type==='receita'?'text-green-600':'text-red-600'}`;dateText.textContent=formatDate(t.date);checkbox.addEventListener('change',()=>handleToggleTransactionStatus(t.id));row.querySelector('.edit-btn').addEventListener('click',()=>openTransactionModal(t));row.querySelector('.delete-btn').addEventListener('click',()=>handleDeleteTransaction(t.id));if(t.abateId||t.isInstallment){const editBtn=row.querySelector('.edit-btn');editBtn.disabled=true;editBtn.classList.add('opacity-50','cursor-not-allowed')}
        container.appendChild(row)});lucide.createIcons();};const renderClientListView=()=>{const container=document.getElementById('consultoria-content');container.innerHTML=document.getElementById('client-list-view-template').innerHTML;const listContainer=document.getElementById('client-list-container');listContainer.innerHTML='';const sortedClients=[...AppState.clients].sort((a,b)=>a.name.localeCompare(b.name));if(sortedClients.length===0){listContainer.innerHTML=`<p class="text-gray-500 col-span-full text-center py-8">Nenhum cliente cadastrado. Clique em "Novo Cliente" para come√ßar.</p>`}else{const cardTemplate=document.getElementById('client-card-template');sortedClients.forEach(client=>{const card=cardTemplate.content.cloneNode(true).firstElementChild;card.dataset.id=client.id;card.querySelector('.client-name').textContent=client.name;card.querySelector('.client-value').textContent=`${formatCurrency(client.valuePerHead)} por cabe√ßa`;card.querySelector('.edit-client-btn').dataset.id=client.id;listContainer.appendChild(card)})}
        lucide.createIcons();};const renderClientDetailView=(clientId)=>{const client=AppState.clients.find(c=>c.id===clientId);if(!client){AppState.currentClientId=null;renderConsultoria();return}
        const container=document.getElementById('consultoria-content');container.innerHTML=document.getElementById('client-detail-view-template').innerHTML;document.getElementById('detail-client-name').textContent=client.name;document.getElementById('detail-client-value').textContent=`${formatCurrency(client.valuePerHead)} por cabe√ßa`;document.getElementById('add-abate-btn').dataset.clientId=client.id;renderAbateList(clientId);lucide.createIcons();};const renderAbateList=(clientId)=>{const listContainer=document.getElementById('abate-list');listContainer.innerHTML='';if(!AppState.currentPeriodStartDate)return;const{start,end}=getPeriodBounds(AppState.currentPeriodStartDate);const abatesInPeriod=AppState.abates.filter(a=>{if(a.isDeleted)return false;const aDate=a.date.toDate?a.date.toDate():new Date(a.date);return a.clientId===clientId&&aDate>=start&&aDate<=end}).sort((a,b)=>(b.date.toDate?b.date.toDate():new Date(b.date))-(a.date.toDate?a.date.toDate():new Date(a.date)));if(abatesInPeriod.length===0){listContainer.innerHTML=`<tr><td colspan="5" class="text-center text-gray-500 py-8">Nenhum abate registrado para este cliente no per√≠odo.</td></tr>`;return}
        const rowTemplate=document.getElementById('abate-row-template');abatesInPeriod.forEach(abate=>{const row=rowTemplate.content.cloneNode(true).firstElementChild;row.dataset.id=abate.id;const client=AppState.clients.find(c=>c.id===abate.clientId);const revenue=(abate.heads*(client?.valuePerHead||0))+abate.revenueDisplacement;const cost=abate.costDisplacement+abate.costAssistant;row.querySelector('.abate-date').textContent=formatDate(abate.date);row.querySelector('.abate-heads').textContent=abate.heads;row.querySelector('.abate-revenue').textContent=formatCurrency(revenue);row.querySelector('.abate-cost').textContent=formatCurrency(cost);row.querySelector('.edit-abate-btn').dataset.id=abate.id;row.querySelector('.delete-abate-btn').dataset.id=abate.id;listContainer.appendChild(row)});lucide.createIcons();};

        // =================================================================================
        // L√ìGICA DOS MODAIS E MANIPULA√á√ÉO DE DADOS
        // =================================================================================
        const getDocRef=(c,d=null)=>{const p=`users/${AppState.userId}/${c}`;return d?doc(db,p,d):doc(collection(db,p))};const getCollRef=(c)=>{const p=`users/${AppState.userId}/${c}`;return collection(db,p)};
        
        const openShortcutModal=async(t,i=null)=>{const isEditing=!!i;const s=isEditing?AppState.shortcuts.find(s=>s.id===i):null;const title=isEditing?'Editar Atalho':`Novo Atalho de ${t==='receita'?'Receita':'Despesa'}`;const availableIcons=["salad","popcorn","shopping-cart","bus","car","home","briefcase","graduation-cap","gift","heart-pulse","piggy-bank","landmark"];const html=`<form id="shortcut-form" class="p-6 space-y-4"><h3 class="text-xl font-bold mb-4">${title}</h3><input type="hidden" name="id" value="${s?.id||''}"><input type="hidden" name="type" value="${s?.type||t}"><div><label class="block text-sm font-medium text-gray-700">Nome</label><input type="text" name="name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${s?.name||''}" required></div><div><label class="block text-sm font-medium text-gray-700">Valor Padr√£o</label><input type="text" name="value" class="currency-input mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${(s?.value||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}" required></div><div><span class="block text-sm font-medium text-gray-700">Frequ√™ncia</span><div id="frequency-selector" class="mt-2 flex gap-4"><label><input type="radio" name="frequency" value="variavel" ${!s||s.frequency==='variavel'?'checked':''}> Lan√ßamento Vari√°vel</label><label><input type="radio" name="frequency" value="fixo" ${s?.frequency==='fixo'?'checked':''}> Lan√ßamento Fixo</label></div></div><div id="due-day-container" class="hidden"><label class="block text-sm font-medium text-gray-700">Dia do Vencimento (1-28)</label><input type="number" name="dueDay" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${s?.dueDay||'11'}" min="1" max="28"></div><div><span class="block text-sm font-medium text-gray-700">√çcone</span><div class="mt-2 grid grid-cols-6 gap-2">${availableIcons.map(icon=>`<label class="p-2 border rounded-md flex justify-center items-center cursor-pointer has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500"><input type="radio" name="icon" value="${icon}" class="sr-only" ${s?.icon===icon?'checked':''}>
        <i data-lucide="${icon}"></i></label>`).join('')}</div></div><div class="flex justify-end gap-4 pt-4"><button type="button" class="cancel-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancelar</button><button type="submit" class="px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 relative"><span class="btn-text">Salvar</span></button></div></form>`;openModal(html,()=>{const d=document.getElementById('due-day-container');const f=document.getElementById('frequency-selector');const t=()=>{if(document.querySelector('input[name="frequency"]:checked').value==='fixo'){d.classList.remove('hidden')}else{d.classList.add('hidden')}};f.addEventListener('change',t);t();document.querySelectorAll('.currency-input').forEach(i=>{i.addEventListener('input',()=>formatCurrencyInput(i))});document.getElementById('shortcut-form').addEventListener('submit',handleSaveShortcut);document.querySelector('.cancel-btn').addEventListener('click',closeModal)})};
        
        const handleSaveShortcut=async e=>{e.preventDefault();const form=e.target;const saveBtn=form.querySelector('button[type="submit"]');const formData=new FormData(form);const id=formData.get('id');const isEditing=!!id;const newShortcutData={name:formData.get('name'),value:parseCurrency(formData.get('value')),type:formData.get('type'),frequency:formData.get('frequency'),dueDay:parseInt(formData.get('dueDay'))||11,icon:formData.get('icon')||'dollar-sign'};saveBtn.disabled=true;saveBtn.classList.add('btn-loading');try{if(isEditing){const oldShortcut=AppState.shortcuts.find(s=>s.id===id);if(oldShortcut&&oldShortcut.frequency==='fixo'&&newShortcutData.frequency==='variavel'){const msg="Converter para 'Vari√°vel' ir√° apagar todas as transa√ß√µes futuras pendentes deste atalho. Deseja continuar?";openConfirmationModal(msg,async()=>{try{const refDate=new Date();await deleteFutureTransactionsForShortcut(id,refDate);await setDoc(getDocRef('shortcuts',id),newShortcutData);showToast('Atalho convertido para vari√°vel.','success')}catch(error){console.error("Erro ao converter atalho:",error);showToast('Erro ao converter o atalho.','error')}});return}}
        let shortcutId=id;if(isEditing){await setDoc(getDocRef('shortcuts',shortcutId),newShortcutData)}else{const docRef=await addDoc(getCollRef('shortcuts'),newShortcutData);shortcutId=docRef.id}
        if(newShortcutData.frequency==='fixo'){if(isEditing){await deleteFutureTransactionsForShortcut(shortcutId,new Date())}
        await generateAndCommitFutureTransactions(shortcutId,newShortcutData)}
        showToast(`Atalho ${isEditing?'atualizado':'salvo'} com sucesso!`)}catch(error){console.error("Erro ao salvar atalho:",error);showToast('Erro ao salvar o atalho: '+error.message,'error')}finally{saveBtn.disabled=false;saveBtn.classList.remove('btn-loading');closeModal()}};
        
        const deleteFutureTransactionsForShortcut=async(s,r)=>{const b=writeBatch(db);const d=AppState.transactions.filter(t=>{const tD=t.date.toDate?t.date.toDate():new Date(t.date);return t.shortcutId===s&&tD>=r&&(t.status!=='pago'&&t.status!=='recebido')});d.forEach(t=>b.delete(getDocRef('transactions',t.id)));if(d.length>0){await b.commit()}};
        
        const generateAndCommitFutureTransactions=async(shortcutId,shortcutData)=>{const periodsToGenerate=60;const batch=writeBatch(db);const dueDay=Math.max(1,Math.min(28,shortcutData.dueDay||11));const today=new Date();const currentYear=today.getUTCFullYear();const currentMonth=today.getUTCMonth();const currentDay=today.getUTCDate();let startMonthIndex=currentMonth;if(currentDay>dueDay){startMonthIndex=currentMonth+1}
        for(let i=0;i<periodsToGenerate;i++){const transactionDate=new Date(Date.UTC(currentYear,startMonthIndex+i,dueDay));const newTxRef=getDocRef('transactions');b.set(newTxRef,{shortcutId:shortcutId,description:shortcutData.name,value:shortcutData.value,date:transactionDate,type:shortcutData.type,status:shortcutData.type==='receita'?'a receber':'a pagar',isDeleted:false})}
        await b.commit()};
        
        const handleShortcutClick=s=>{const t=AppState.shortcuts.find(t=>t.id===s);if(!t)return;if(t.frequency==='variavel'){openTransactionModal({description:t.name,value:0,type:t.type,date:new Date().toISOString().split('T')[0],shortcutId:t.id})}else{showToast("Esta √© uma transa√ß√£o fixa, j√° lan√ßada automaticamente.","info")}};const handleDeleteShortcutPermanently=s=>{const m="Tem certeza que deseja excluir permanentemente este atalho e TODAS as suas transa√ß√µes futuras? Esta a√ß√£o √© irrevers√≠vel.";openConfirmationModal(m,async()=>{try{const b=writeBatch(db);const d=AppState.transactions.filter(t=>t.shortcutId===s);d.forEach(t=>b.delete(getDocRef('transactions',t.id)));b.delete(getDocRef('shortcuts',s));await b.commit();showToast('Atalho e transa√ß√µes exclu√≠dos com sucesso!','success')}catch(e){console.error("Erro ao excluir atalho:",e);showToast('Erro ao excluir o atalho.','error')}})};
        
        const openTransactionModal=(t=null)=>{const isEditing=!!t?.id;const title=isEditing?'Editar Transa√ß√£o':'Nova Transa√ß√£o';const today=new Date().toISOString().split('T')[0];const html=`<form id="transaction-form" class="p-6 space-y-4"><h3 class="text-xl font-bold mb-4">${title}</h3><input type="hidden" name="id" value="${t?.id||''}"><input type="hidden" name="shortcutId" value="${t?.shortcutId||''}"><div><label class="block text-sm font-medium text-gray-700">Descri√ß√£o</label><input type="text" name="description" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${t?.description||''}" required></div><div><label class="block text-sm font-medium text-gray-700">Valor</label><input type="text" name="value" class="currency-input mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${(t?.value||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}" required></div><div><label class="block text-sm font-medium text-gray-700">Data</label><input type="date" name="date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${t?.date?(t.date.toDate?t.date.toDate():new Date(t.date)).toISOString().split('T')[0]:today}" required></div><div><span class="block text-sm font-medium text-gray-700">Tipo</span><div class="mt-2 flex gap-4"><label><input type="radio" name="type" value="receita" ${!t||t.type==='receita'?'checked':''}> Receita</label><label><input type="radio" name="type" value="despesa" ${t?.type==='despesa'?'checked':''}> Despesa</label></div></div><div><span class="block text-sm font-medium text-gray-700">Status</span><div class="mt-2 flex gap-4"><label><input type="radio" name="status" value="a_pagar" ${!t||t.status==='a receber'||t.status==='a pagar'?'checked':''}> Pendente</label><label><input type="radio" name="status" value="pago" ${t?.status==='recebido'||t?.status==='pago'?'checked':''}> Conclu√≠do</label></div></div><div id="installment-section" class="hidden"><label class="block text-sm font-medium text-gray-700">N√∫mero de Parcelas</label><input type="number" name="installments" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="2" min="2" max="60"><p class="text-sm text-gray-500 mt-1">Apenas para despesas. Criar√° m√∫ltiplas transa√ß√µes mensais.</p></div><div class="flex justify-end gap-4 pt-4"><button type="button" class="cancel-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancelar</button><button type="submit" class="px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 relative"><span class="btn-text">Salvar</span></button></div></form>`;openModal(html,()=>{const t=document.querySelectorAll('input[name="type"]');const i=document.getElementById('installment-section');const s=()=>{const s=document.querySelector('input[name="type"]:checked').value;if(s==='despesa'&&!isEditing){i.classList.remove('hidden')}else{i.classList.add('hidden')}};t.forEach(t=>t.addEventListener('change',s));s();document.querySelectorAll('.currency-input').forEach(i=>{i.addEventListener('input',()=>formatCurrencyInput(i))});document.getElementById('transaction-form').addEventListener('submit',handleSaveTransaction);document.querySelector('.cancel-btn').addEventListener('click',closeModal)})};
        
        const handleSaveTransaction=async e=>{e.preventDefault();const form=e.target;const saveBtn=form.querySelector('button[type="submit"]');const formData=new FormData(form);const description=formData.get('description');const installments=parseInt(formData.get('installments'));saveBtn.disabled=true;saveBtn.classList.add('btn-loading');try{if(!formData.get('id')&&formData.get('type')==='despesa'&&installments>1){const totalValue=parseCurrency(formData.get('value'));const numInstallments=parseInt(formData.get('installments'));const firstDueDate=new Date(formData.get('date')+'T00:00:00');if(numInstallments<=1){showToast('O n√∫mero de parcelas deve ser 2 ou maior.','error');return}
        const installmentValue=totalValue/numInstallments;const installmentGroupId=generateUUID();const batch=writeBatch(db);for(let i=0;i<numInstallments;i++){const dueDate=new Date(firstDueDate);dueDate.setUTCMonth(firstDueDate.getUTCMonth()+i);const txData={description:`${description} (${i+1}/${numInstallments})`,value:installmentValue,date:dueDate,type:'despesa',status:'a pagar',isInstallment:true,installmentGroupId:installmentGroupId,isDeleted:false};const newTxRef=getDocRef('transactions');batch.set(newTxRef,txData)}
        await batch.commit();showToast(`${numInstallments} parcelas criadas com sucesso!`,'success')}else{const id=formData.get('id');const isEditing=!!id;const type=formData.get('type');let status=formData.get('status');if(status==='a_pagar')status=type==='receita'?'a receber':'a pagar';if(status==='pago')status=type==='receita'?'recebido':'pago';const txData={description:formData.get('description'),value:parseCurrency(formData.get('value')),date:new Date(formData.get('date')+'T00:00:00'),type:type,status:status,shortcutId:formData.get('shortcutId')||(isEditing?AppState.transactions.find(t=>t.id===id).shortcutId:null),abateId:isEditing?AppState.transactions.find(t=>t.id===id).abateId:null,isDeleted:false};if(isEditing){await setDoc(getDocRef('transactions',id),txData)}else{await addDoc(getCollRef('transactions'),txData)}
        showToast(`Transa√ß√£o ${isEditing?'atualizada':'salva'} com sucesso!`)}
        }catch(error){console.error("Error saving transaction: ",error);showToast('Erro ao salvar transa√ß√£o.','error')}finally{saveBtn.disabled=false;saveBtn.classList.remove('btn-loading');closeModal()}};
        
        const handleDeleteTransaction=i=>{const t=AppState.transactions.find(t=>t.id===i);if(!t)return;if(t.shortcutId){const m="Esta transa√ß√£o faz parte de um lan√ßamento fixo. Deseja excluir apenas esta ocorr√™ncia?";openConfirmationModal(m,async()=>{await setDoc(getDocRef('transactions',i),{isDeleted:true},{merge:true});showToast('Transa√ß√£o exclu√≠da com sucesso!','success')})}else if(t.isInstallment){const m="Esta transa√ß√£o √© uma parcela. Deseja excluir todas as parcelas futuras desta compra?";openConfirmationModal(m,async()=>{const txsToDelete=AppState.transactions.filter(tx=>(tx.installmentGroupId===t.installmentGroupId&&tx.date.toDate()>=t.date.toDate()));const batch=writeBatch(db);txsToDelete.forEach(tx=>batch.update(getDocRef('transactions',tx.id),{isDeleted:true}));await batch.commit();showToast('Parcelas exclu√≠das com sucesso!','success')})}else{const m="Tem certeza que deseja excluir esta transa√ß√£o? Esta a√ß√£o √© irrevers√≠vel.";openConfirmationModal(m,async()=>{await deleteDoc(getDocRef('transactions',i));showToast('Transa√ß√£o exclu√≠da com sucesso!','success')})}};const handleToggleTransactionStatus=async i=>{const t=AppState.transactions.find(t=>t.id===i);if(!t)return;let n=t.status;if(t.type==='receita'){n=t.status==='recebido'?'a receber':'recebido'}else{n=t.status==='pago'?'a pagar':'pago'}
        try{await setDoc(getDocRef('transactions',i),{status:n},{merge:true});showToast('Status da transa√ß√£o atualizado!','success')}catch(e){console.error("Error updating status: ",e);showToast('Erro ao atualizar status.','error')}};const openClientModal=(i=null)=>{const isEditing=!!i;const c=isEditing?AppState.clients.find(c=>c.id===i):null;const title=isEditing?'Editar Cliente':'Novo Cliente';const html=`<form id="client-form" class="p-6 space-y-4"><h3 class="text-xl font-bold mb-4">${title}</h3><input type="hidden" name="id" value="${c?.id||''}"><div class="space-y-2"><label class="block text-sm font-medium text-gray-700">Nome do Cliente</label><input type="text" name="name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${c?.name||''}" required></div><div class="space-y-2"><label class="block text-sm font-medium text-gray-700">Valor por Cabe√ßa (R$)</label><input type="text" name="valuePerHead" class="currency-input mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${(c?.valuePerHead||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}" required></div><div class="flex justify-end gap-4 pt-4"><button type="button" class="cancel-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancelar</button><button type="submit" class="px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 relative"><span class="btn-text">Salvar</span></button></div></form>`;openModal(html,()=>{document.querySelectorAll('.currency-input').forEach(i=>{i.addEventListener('input',()=>formatCurrencyInput(i))});document.getElementById('client-form').addEventListener('submit',handleSaveClient);document.querySelector('.cancel-btn').addEventListener('click',closeModal)})};const handleSaveClient=async e=>{e.preventDefault();const form=e.target;const saveBtn=form.querySelector('button[type="submit"]');const formData=new FormData(form);const id=formData.get('id');const isEditing=!!id;const clientData={name:formData.get('name'),valuePerHead:parseCurrency(formData.get('valuePerHead'))};saveBtn.disabled=true;saveBtn.classList.add('btn-loading');try{if(isEditing){await setDoc(getDocRef('clients',id),clientData)}else{await addDoc(getCollRef('clients'),clientData)}
        showToast(`Cliente ${isEditing?'atualizado':'salvo'} com sucesso!`)}catch(e){console.error("Error saving client:",e);showToast('Erro ao salvar cliente.','error')}finally{saveBtn.disabled=false;saveBtn.classList.remove('btn-loading');closeModal()}};const openAbateModal=(c,i=null)=>{const isEditing=!!i;const a=isEditing?AppState.abates.find(a=>a.id===i):null;const client=AppState.clients.find(cl=>cl.id===c);const title=isEditing?'Editar Abate':'Novo Abate';const today=new Date().toISOString().split('T')[0];const html=`<form id="abate-form" class="p-6 space-y-4"><h3 class="text-xl font-bold mb-4">${title} para ${client.name}</h3><input type="hidden" name="id" value="${a?.id||''}"><input type="hidden" name="clientId" value="${c}"><div><label class="block text-sm font-medium text-gray-700">Data do Abate</label><input type="date" name="date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${(a?.date.toDate?a.date.toDate():new Date(a?.date||today)).toISOString().split('T')[0]}" required></div><div><label class="block text-sm font-medium text-gray-700">N¬∫ de Cabe√ßas</label><input type="number" name="heads" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${a?.heads||1}" min="1" required></div><div><label class="block text-sm font-medium text-gray-700">Receita de Deslocamento (Opcional)</label><input type="text" name="revenueDisplacement" class="currency-input mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${(a?.revenueDisplacement||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}"></div><div><label class="block text-sm font-medium text-gray-700">Custo com Deslocamento (Opcional)</label><input type="text" name="costDisplacement" class="currency-input mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${(a?.costDisplacement||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}"></div><div><label class="block text-sm font-medium text-gray-700">Custo com Diarista (Opcional)</label><input type="text" name="costAssistant" class="currency-input mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${(a?.costAssistant||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}"></div><div class="flex justify-end gap-4 pt-4"><button type="button" class="cancel-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancelar</button><button type="submit" class="px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 relative"><span class="btn-text">Salvar</span></button></div></form>`;openModal(html,()=>{document.querySelectorAll('.currency-input').forEach(i=>{i.addEventListener('input',()=>formatCurrencyInput(i))});document.getElementById('abate-form').addEventListener('submit',handleSaveAbate);document.querySelector('.cancel-btn').addEventListener('click',closeModal)})};const handleSaveAbate=async e=>{e.preventDefault();const form=e.target;const saveBtn=form.querySelector('button[type="submit"]');const formData=new FormData(form);const id=formData.get('id');const isEditing=!!id;const abateData={clientId:formData.get('clientId'),date:new Date(formData.get('date')+'T00:00:00'),heads:parseInt(formData.get('heads')),revenueDisplacement:parseCurrency(formData.get('revenueDisplacement')),costDisplacement:parseCurrency(formData.get('costDisplacement')),costAssistant:parseCurrency(formData.get('costAssistant'))};saveBtn.disabled=true;saveBtn.classList.add('btn-loading');try{let abateId=id;if(isEditing){const txsToDelete=AppState.transactions.filter(t=>t.abateId===id);const deleteBatch=writeBatch(db);txsToDelete.forEach(t=>deleteBatch.delete(getDocRef('transactions',t.id)));await deleteBatch.commit();await setDoc(getDocRef('abates',id),abateData)}else{const newAbateRef=await addDoc(getCollRef('abates'),abateData);abateId=newAbateRef.id}
        await createTransactionsForAbate(abateId,abateData);showToast(`Abate ${isEditing?'atualizado':'salvo'} com sucesso!`)}catch(error){console.error("Error saving abate: ",error);showToast('Erro ao salvar abate.','error')}finally{saveBtn.disabled=false;saveBtn.classList.remove('btn-loading');closeModal()}};const createTransactionsForAbate=async(i,d)=>{const c=AppState.clients.find(c=>c.id===d.clientId);if(!c)return;const m=(d.heads*c.valuePerHead)+d.revenueDisplacement;const b=writeBatch(db);const mainRevenueRef=getDocRef('transactions');b.set(mainRevenueRef,{abateId:i,description:`Abate - ${c.name}`,value:m,date:d.date,type:'receita',status:'a receber',isDeleted:false});if(d.costDisplacement>0){const costDisplacementRef=getDocRef('transactions');b.set(costDisplacementRef,{abateId:i,description:`Custo Deslocamento - ${c.name}`,value:d.costDisplacement,date:d.date,type:'despesa',status:'a pagar',isDeleted:false})}
        if(d.costAssistant>0){const costAssistantRef=getDocRef('transactions');b.set(costAssistantRef,{abateId:i,description:`Custo Diarista - ${c.name}`,value:d.costAssistant,date:d.date,type:'despesa',status:'a pagar',isDeleted:false})}
        await b.commit()};const handleDeleteAbate=i=>{const m="Excluir este abate tamb√©m remover√° as transa√ß√µes financeiras associadas. Deseja continuar?";openConfirmationModal(m,async()=>{const b=writeBatch(db);const d=AppState.transactions.filter(t=>t.abateId===i);d.forEach(t=>b.delete(getDocRef('transactions',t.id)));b.delete(getDocRef('abates',i));await b.commit();showToast('Abate e transa√ß√µes associadas exclu√≠dos com sucesso!','success')})};

        // =================================================================================
        // L√ìGICA DE AUTENTICA√á√ÉO
        // =================================================================================
        const handleAuth=async e=>{e.preventDefault();const form=e.target;const submitter=e.submitter;const formData=new FormData(form);const email=formData.get('email');const password=formData.get('password');const action=submitter.value;const errorDiv=document.getElementById('auth-error');const buttons=form.querySelectorAll('button');buttons.forEach(btn=>btn.disabled=true);submitter.classList.add('btn-loading');errorDiv.textContent='';try{if(action==='login'){await signInWithEmailAndPassword(auth,email,password)}else{await createUserWithEmailAndPassword(auth,email,password)}}catch(error){console.error('Auth error:',error.code);let message='Ocorreu um erro. Tente novamente.';switch(error.code){case'auth/user-not-found':case'auth/wrong-password':case'auth/invalid-credential':message='Email ou senha incorretos.';break;case'auth/email-already-in-use':message='Este email j√° est√° cadastrado.';break;case'auth/weak-password':message='A senha deve ter no m√≠nimo 6 caracteres.';break;case'auth/invalid-email':message='O formato do email √© inv√°lido.';break}
        errorDiv.textContent=message}finally{buttons.forEach(btn=>btn.disabled=false);submitter.classList.remove('btn-loading')}};const handleLogout=async()=>{try{detachFirestoreListeners();await signOut(auth);showToast('Logout realizado com sucesso!','success')}catch(error){console.error('Logout error:',error);showToast('Erro ao fazer logout.','error')}};const resetAppState=()=>{AppState.userId=null;AppState.transactions=[];AppState.shortcuts=[];AppState.clients=[];AppState.abates=[];AppState.currentClientId=null;detachFirestoreListeners()};

        // =================================================================================
        // INICIALIZA√á√ÉO E EVENT LISTENERS
        // =================================================================================
        const main=()=>{if(!firebaseConfig){console.error("Configura√ß√£o do Firebase n√£o encontrada.");document.getElementById('loading-container').innerHTML=`<div class="text-center p-4"><i data-lucide="alert-triangle" class="w-16 h-16 mx-auto text-red-500"></i><p class="mt-4 text-lg text-red-600 font-semibold">Erro Cr√≠tico</p><p class="text-gray-600">A configura√ß√£o do Firebase n√£o foi fornecida.</p></div>`;lucide.createIcons();return}
        fbApp=initializeApp(firebaseConfig);auth=getAuth(fbApp);db=getFirestore(fbApp);try{enableIndexedDbPersistence(db).catch((err)=>{if(err.code=='failed-precondition'){console.warn('Firebase: Persist√™ncia falhou, m√∫ltiplas abas abertas.')}else if(err.code=='unimplemented'){console.warn('Firebase: Persist√™ncia n√£o suportada neste navegador.')}})}catch(error){console.error("Erro ao ativar persist√™ncia offline",error)}
        onAuthStateChanged(auth,(user)=>{document.getElementById('loading-container').classList.add('hidden');if(user){AppState.userId=user.uid;document.getElementById('user-display').textContent=`Logado como: ${user.email}`;document.getElementById('auth-container').classList.add('hidden');document.getElementById('app-container').classList.remove('hidden');initializePeriod();setupFirestoreListeners(user.uid);renderAll()}else{resetAppState();document.getElementById('app-container').classList.add('hidden');document.getElementById('auth-container').classList.remove('hidden')}
        lucide.createIcons()});document.getElementById('login-form').addEventListener('submit',handleAuth);document.getElementById('logout-btn').addEventListener('click',handleLogout);document.getElementById('prev-period').addEventListener('click',()=>changePeriod(-1));document.getElementById('next-period').addEventListener('click',()=>changePeriod(1));document.getElementById('transaction-search').addEventListener('input',renderTransactionList);document.querySelectorAll('.tab-item').forEach(tab=>{tab.addEventListener('click',()=>{AppState.currentTab=tab.dataset.tab;renderAll()})});document.addEventListener('click',(e)=>{const target=e.target;if(target.closest('.new-shortcut-btn')){openShortcutModal(target.closest('.new-shortcut-btn').dataset.type)}
        if(target.closest('.shortcut-card')&&!target.closest('.edit-shortcut-btn')&&!target.closest('.delete-shortcut-btn')){handleShortcutClick(target.closest('.shortcut-card').dataset.id)}
        if(target.closest('.edit-shortcut-btn')){e.stopPropagation();const shortcutId=target.closest('.shortcut-card').dataset.id;const shortcut=AppState.shortcuts.find(s=>s.id===shortcutId);if(shortcut)openShortcutModal(shortcut.type,shortcutId)}
        if(target.closest('.delete-shortcut-btn')){e.stopPropagation();handleDeleteShortcutPermanently(target.closest('.shortcut-card').dataset.id)}
        if(target.closest('#add-generic-transaction-btn'))openTransactionModal();const consultoriaContent=document.getElementById('consultoria-content');if(consultoriaContent.contains(target)){if(target.closest('#add-client-btn'))openClientModal();if(target.closest('.client-card')&&!target.closest('.edit-client-btn')){AppState.currentClientId=target.closest('.client-card').dataset.id;renderConsultoria()}
        if(target.closest('.edit-client-btn')){openClientModal(target.closest('[data-id]').dataset.id)}
        if(target.closest('#back-to-clients-btn')){AppState.currentClientId=null;renderConsultoria()}
        if(target.closest('#add-abate-btn'))openAbateModal(target.closest('#add-abate-btn').dataset.clientId);if(target.closest('.edit-abate-btn')){const abateId=target.closest('[data-id]').dataset.id;const abate=AppState.abates.find(a=>a.id===abateId);if(abate)openAbateModal(abate.clientId,abateId)}
        if(target.closest('.delete-abate-btn'))handleDeleteAbate(target.closest('[data-id]').dataset.id)}});};main();
    </script>
</body>
</html>
